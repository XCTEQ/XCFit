#!/usr/bin/env bash

set -e

echo "Swift 4 Circle CI Installer";

# Determine version
VERSION_FILE=".swift-version"
if [ ! -f $VERSION_FILE ];
then
    echo "No .swift-version file found."
    exit 1
fi
VERSION=`cat $VERSION_FILE | tr -d '[[:space:]]'`
echo "ğŸ“… Version: $VERSION";

# Determine OS
UNAME=`uname`;
if [[ $UNAME == "Linux" ]];
then
    UBUNTU_RELEASE=`lsb_release -a 2>/dev/null`;
    if [[ $UBUNTU_RELEASE == *"15.10"* ]];
    then
        OS="ubuntu1510";
    else
        OS="ubuntu1404";
    fi
else
    echo "Unsupported Operating System: $UNAME";
fi
echo "ğŸ–¥ Operating System: $OS";

echo "ğŸ“¦ Installing Swiftenv"
git clone --depth 1 https://github.com/kylef/swiftenv.git ~/.swiftenv
export SWIFTENV_ROOT="$HOME/.swiftenv"
export PATH="$SWIFTENV_ROOT/bin:$SWIFTENV_ROOT/shims:$PATH"

echo "ğŸ“š Installing Dependencies"
sudo apt-get install -y clang libicu-dev

echo "ğŸ¦ Installing Swift";
swiftenv install $VERSION;

echo "ğŸš€ Building";
swift build
if [[ $? != 0 ]];
then
    echo "âŒ  Build failed";
    exit 1;
fi

echo "ğŸ’¼ Building Release";
swift build -c release
if [[ $? != 0 ]];
then
    echo "âŒ  Build for release failed";
    exit 1;
fi

echo "ğŸ” Testing";

swift test
if [[ $? != 0 ]];
then
    echo "âŒ Tests failed";
    exit 1;
fi

echo "âœ… Done";
